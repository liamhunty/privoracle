# PrivOracle

PrivOracle is a Fully Homomorphic Encryption (FHE) powered daily price prediction game for ETH and BTC. Users submit
encrypted predictions for the next day and stake ETH. After the daily price is recorded, users confirm their prediction
to receive encrypted points equal to their stake when correct. The protocol keeps prediction values and directions
private on-chain while remaining verifiable and auditable.

## Overview

PrivOracle addresses a common tradeoff in prediction games: privacy versus verifiability. Public predictions can be
copied or influenced, while private predictions are hard to verify. By using Zama FHEVM, PrivOracle keeps the prediction
price and direction encrypted on-chain, yet still allows on-chain evaluation when the actual price is known.

## Problem Statement

- Public predictions expose user intent and can be copied or front-run.
- Traditional private predictions require trusted servers to compute outcomes.
- Users need a simple daily flow that does not leak price targets or bias the market.
- Predictions should be provable without revealing the underlying encrypted data.

## Solution Summary

- Encrypted inputs for both predicted price and direction (greater than or less than).
- Daily price recorded once per asset at UTC 00:00 by the contract owner.
- On-chain evaluation of correctness using FHE, without revealing the prediction.
- Encrypted points balance to preserve user privacy even after rewards are assigned.

## Key Advantages

- Privacy-preserving predictions: price and direction never appear in plaintext on-chain.
- Verifiable outcomes: correctness is computed on-chain with FHE operations.
- Minimal trust: only the daily price recording requires a trusted owner.
- Simplicity: one prediction per asset per day, one confirmation per prediction.
- Composability: integrates with standard wallets and EVM tooling.

## How It Works (Daily Cycle)

1) Daily price update (UTC 00:00)
- The owner records the price for ETH and BTC for the current day.
- The recorded price is stored on-chain in plaintext for transparency.

2) User prediction for tomorrow
- The user encrypts their predicted price (euint64) and direction (euint8).
- Direction encoding: 1 means actual price greater than prediction; 2 means less than prediction.
- The user stakes ETH when calling `placePrediction`.

3) Next day confirmation
- After the daily price is recorded, the user calls `confirmPrediction`.
- The contract compares the encrypted prediction to the recorded price with FHE.
- If correct, encrypted points are increased by the staked amount.

4) Points visibility
- Points remain encrypted on-chain.
- Users can decrypt their own points through the FHEVM relayer flow.

## Core Contract Behavior

Contract: `contracts/PrivOracle.sol`

- Assets supported: ETH (0) and BTC (1).
- Daily index: `block.timestamp / 1 days`.
- Prediction window: only tomorrow (`currentDay + 1`).
- One prediction per user per asset per day.
- Only the owner can record prices.
- Stake is ETH sent with the prediction transaction.
- Rewards are encrypted points; no token minting or ETH payout.

Events emitted:

- `PriceRecorded(asset, day, price)`
- `PredictionPlaced(user, asset, day, stake)`
- `PredictionConfirmed(user, asset, day)`

## Encryption Model

PrivOracle uses Zama FHEVM types and operations:

- Encrypted inputs are submitted using `externalEuint64` and `externalEuint8`.
- The contract converts inputs to `euint64` and `euint8` with proofs.
- FHE comparisons (`gt`, `lt`, `eq`) operate on encrypted values.
- Rewards are computed with `select` and added to an encrypted points balance.

Only the user can decrypt their points using the relayer flow. The contract still enforces correctness without ever
revealing the prediction price or direction.

## Frontend Integration Notes

The frontend lives in `app/` and uses:

- React + Vite
- RainbowKit and wagmi for wallet connection
- viem for read calls
- ethers for write calls
- Zama relayer SDK for encryption and decryption

Important integration rules:

- The frontend must use the ABI generated by the contract build, located in `deployments/sepolia`.
- Copy the ABI array into a TypeScript file in the frontend; do not import JSON files in the frontend.
- The frontend should not use environment variables, localStorage, or localhost-only networks.

## Tech Stack

- Smart contracts: Solidity, FHEVM, Zama FHE types
- Framework: Hardhat, hardhat-deploy
- Encryption tools: @fhevm/solidity, @fhevm/hardhat-plugin
- Frontend: React, Vite, RainbowKit, wagmi, viem, ethers
- Relayer: @zama-fhe/relayer-sdk

## Repository Structure

- `contracts/` smart contracts
- `deploy/` deployment scripts
- `tasks/` Hardhat tasks for recording prices and predicting
- `test/` contract tests
- `app/` frontend (React + Vite)
- `docs/` project and Zama integration docs

## Setup and Usage

### Prerequisites

- Node.js 20+
- npm
- An Ethereum wallet and private key for deployment

### Install dependencies

```bash
npm install
```

### Compile and test

```bash
npm run compile
npm run test
```

### Local development network

```bash
npx hardhat node
npx hardhat deploy --network localhost
```

### Deploy to Sepolia

Create a `.env` file in the project root:

```bash
INFURA_API_KEY=your_infura_key
PRIVATE_KEY=your_private_key
```

Deploy:

```bash
npx hardhat deploy --network sepolia
```

### Hardhat tasks

Get deployed contract address:

```bash
npx hardhat task:address --network sepolia
```

Record daily price (owner):

```bash
npx hardhat task:record-price --asset ETH --price 3500 --network sepolia
```

Place an encrypted prediction:

```bash
npx hardhat task:place-prediction --asset ETH --price 3600 --direction 1 --stake 0.01 --network sepolia
```

Confirm prediction and apply points:

```bash
npx hardhat task:confirm-prediction --asset ETH --day 20300 --network sepolia
```

Decrypt your encrypted points:

```bash
npx hardhat task:decrypt-points --network sepolia
```

## Operational Notes

- Daily price should be recorded at UTC 00:00 for consistency.
- If the actual price equals the predicted price, the prediction is not considered correct.
- Predictions are permanent once placed; only confirmation finalizes the outcome.
- Points are stored encrypted and are not ERC20 tokens.

## Future Roadmap

- Automated price feeds with multi-source oracle aggregation.
- Support for additional assets and custom prediction windows.
- User-configurable stakes and optional pooled rewards.
- Reputation and leaderboard views with privacy-preserving totals.
- Batch confirmations to reduce gas costs.
- Optional points redemption or governance integrations.

## License

BSD-3-Clause-Clear. See `LICENSE`.
